# Ralph Progress Log
Started: Wed Jan 28 15:58:34 AST 2026

## Codebase Patterns
- Use `python3` not `python` for all CLI commands on macOS
- Directory structure: macro_v/, micro_v/, shared/, tests/ with __init__.py in each
- CLI uses argparse with subparsers for run/status commands
---

## 2026-01-28 16:00 - US-001
- What was implemented: Basic project scaffolding and CLI entry point
- Files changed:
  - v_ralph.py (main CLI with --help, --version, run, status subcommands)
  - macro_v/__init__.py, micro_v/__init__.py, shared/__init__.py, tests/__init__.py (module init files)
  - README.md (installation and basic usage documentation)
- **Learnings for future iterations:**
  - Use `python3` command not `python` on macOS (python may not be in PATH)
  - The prd.json uses JSON format, not YAML as mentioned in some story descriptions
  - Working directory is scripts/ralph/ within the ralph-wiggum repo
---

## 2026-01-28 16:15 - US-002
- What was implemented: PRD read/write module with typed dataclasses
- Files changed:
  - shared/prd.py (load_prd, save_prd, get_pending_stories, mark_story_passed, increment_attempts)
  - tests/test_prd.py (16 unit tests covering all functions)
- **Learnings for future iterations:**
  - pytest must be installed (`pip3 install pytest`)
  - Use `from shared.prd import ...` for imports when running tests from scripts/ralph/
  - The PRD module uses dataclasses for typed data structures: PRD, UserStory, VerificationCommands
  - PRDError exception for graceful error handling
---

## 2026-01-28 16:30 - US-003
- What was implemented: Claude CLI wrapper module for spawning stateless Claude instances
- Files changed:
  - shared/claude.py (invoke_claude function with subprocess handling)
  - tests/test_claude.py (19 unit tests mocking subprocess)
- **Learnings for future iterations:**
  - Use subprocess.Popen with communicate() for timeout support
  - Always call wait() after terminate/kill to reap zombie processes
  - Handle FileNotFoundError when 'claude' command not in PATH
  - The module provides ClaudeResult dataclass and ClaudeError exception for consistency with prd.py patterns
---

## 2026-01-28 17:45 - US-004
- What was implemented: Two-tier progress tracking module with load_learnings and append_progress functions
- Files changed:
  - shared/progress.py (ProgressContext dataclass, load_learnings, append_progress, helper functions)
  - tests/test_progress.py (24 unit tests covering two-tier loading, appending, and edge cases)
- **Learnings for future iterations:**
  - Use `"- "` (with space) to match bullet points but not `---` separators
  - History entries start with `## YYYY-MM-DD` format to distinguish from other ## headers
  - The ProgressContext dataclass follows the same pattern as other modules
  - Template structure includes both "Codebase Patterns" and "Recent History" sections
---

## 2026-01-28 18:10 - US-005
- What was implemented: Coder prompt template with all required placeholders and instructions
- Files changed:
  - micro_v/prompts/coder.md (new file - coder agent instructions with {{goal}}, {{files}}, {{criteria}}, {{learnings}} placeholders)
  - README.md (added Prompt Customization section documenting template usage)
- **Learnings for future iterations:**
  - Prompt templates live in micro_v/prompts/ directory
  - The four placeholders are filled at runtime by the executor
  - Forbidden shortcuts section prevents agents from using quality-bypassing hacks
  - README customization section shows how to modify prompts while preserving required placeholders
---

## 2026-01-28 18:30 - US-006
- What was implemented: Micro-V executor loop with retry mechanism and circuit breaker
- Files changed:
  - micro_v/executor.py (execute_story function with retry loop, ExecutionResult enum, ExecutorConfig and ExecutionOutput dataclasses)
  - tests/test_executor.py (31 unit tests covering success, failure, circuit breaker paths)
- **Learnings for future iterations:**
  - The executor uses invoke_claude from shared/claude.py for Claude CLI interactions
  - ExecutionResult enum has SUCCESS, FAILED, and ESCALATED values (ESCALATED used by auditor in US-008)
  - Validation runs via subprocess.run with shell=True (120s timeout)
  - Error context from failed validations is passed to the next iteration via the prompt
  - Circuit breaker default is 5 retries (configurable via ExecutorConfig.max_retries)
  - The _log function prefixes all output with [executor] for clear terminal logging
---

## 2026-01-28 19:00 - US-007
- What was implemented: Adversarial auditor prompt template for semantic validation
- Files changed:
  - micro_v/prompts/auditor.md (new file - skeptical QA engineer prompt with PASS/RETRY/ESCALATE verdicts)
  - README.md (added Three-Layer Validation Model section)
- **Learnings for future iterations:**
  - Auditor prompt uses {{spec}} and {{diff}} placeholders (different from coder's {{goal}}, {{files}}, {{criteria}}, {{learnings}})
  - The three-layer model: 1) Coder implements, 2) Automated checks (typecheck/lint/test), 3) Semantic audit
  - ESCALATE is high bar - only for spec ambiguity, not bugs (bugs are RETRY)
  - Auditor sees only spec + diff, no context from coding session for fresh perspective
---

## 2026-01-28 19:30 - US-008
- What was implemented: Semantic auditor module to catch green build hallucinations
- Files changed:
  - micro_v/auditor.py (AuditVerdict enum, AuditResult dataclass, audit_implementation function)
  - tests/test_auditor.py (32 unit tests covering all verdict types and edge cases)
- **Learnings for future iterations:**
  - AuditVerdict enum mirrors the prompt format: PASS, RETRY, ESCALATE
  - _parse_verdict() extracts verdict from Claude output using regex patterns
  - Defaults to RETRY (conservative) if verdict cannot be parsed clearly
  - AuditorError exception follows same pattern as ClaudeError and PRDError
  - Invocation failure returns RETRY (not ESCALATE) to let the system try again
  - Test pattern: mock both _load_auditor_prompt and invoke_claude to isolate logic
---

## 2026-01-28 20:00 - US-009
- What was implemented: Semantic audit integration into executor loop
- Files changed:
  - micro_v/executor.py (added audit_implementation call after validation passes, PASS/RETRY/ESCALATE handling)
  - tests/test_executor.py (added 11 new tests including 6 audit integration tests)
- **Learnings for future iterations:**
  - ExecutorConfig now has enable_audit (bool) to toggle audit on/off - useful for testing
  - _build_spec() creates spec from story for auditor, _get_git_diff() retrieves current changes
  - Audit retries use same circuit breaker as validation failures (max_retries applies to total iterations)
  - When adding new features to executor, update default_config fixture to disable new features for existing tests
  - Auditor feedback is included in error_context for next coder iteration (prefixed with "Semantic audit requested changes:")
---

## 2026-01-28 20:30 - US-010
- What was implemented: Git integration module for committing completed work
- Files changed:
  - shared/git.py (commit_story, get_staged_files, get_dirty_files, reset_staged functions with CommitResult dataclass)
  - tests/test_git.py (34 unit tests mocking git commands)
- **Learnings for future iterations:**
  - Use subprocess.run with capture_output=True for simple git commands
  - Check for changes with `git diff --name-only HEAD` for tracked files and `git ls-files --others --exclude-standard` for untracked
  - CommitResult dataclass follows same pattern as ClaudeResult (success, sha, error fields)
  - GitError exception follows same pattern as ClaudeError and PRDError
  - File existence must be checked before git diff (non-existent files in whitelist are silently skipped)
  - Commit message format is enforced: "feat: {story_id} - {title}"
---

## 2026-01-28 21:00 - US-011
- What was implemented: Status command to display story progress in formatted table
- Files changed:
  - v_ralph.py (added cmd_status function with PRD loading, table formatting, and progress summary)
  - README.md (added Status Command documentation section with usage examples)
- **Learnings for future iterations:**
  - Use DEFAULT_PRD_PATH = Path(__file__).parent / "prd.json" for relative default paths
  - The status command falls back to prd.yml if prd.json doesn't exist (same as other tools)
  - Table formatting uses f-strings with width specifiers for alignment
  - UserStory dataclass doesn't have an 'escalated' field yet - check with hasattr before use
---

## 2026-01-28 21:30 - US-012
- What was implemented: Run command with full integration for autonomous story execution
- Files changed:
  - v_ralph.py (added cmd_run function with story loop, dry-run mode, escalation/circuit breaker handling)
  - README.md (added Run Command documentation with flags table and exit codes)
- **Learnings for future iterations:**
  - The run command integrates executor, git, progress, and PRD modules together
  - _get_modified_files() helper finds all changed files for commit (tracked + untracked)
  - Exit code 2 is reserved for escalation (human input required)
  - Circuit breaker just continues to next story (no separate escalated field in UserStory)
  - args.prd and args.progress may be None, so check before using Path()
---

## 2026-01-28 22:00 - US-013
- What was implemented: Macro-V planning skill for Claude Code with interactive spec refinement
- Files changed:
  - .claude/skills/v-ralph-planning/SKILL.md (new file - planning skill for machine-verifiable specs)
  - scripts/ralph/README.md (added Planning with V-Ralph section)
  - .gitignore (updated to allow .claude/skills/ directory)
- **Learnings for future iterations:**
  - Skills use YAML frontmatter with name and description fields
  - The .claude directory was originally ignored; updated .gitignore pattern to `!.claude/skills/` to allow skill tracking
  - Skill triggers are listed in description field (e.g., "Triggers on: v-ralph planning, create v-ralph spec")
  - Machine-verifiable criteria need explicit verification commands (grep, test -f, python -c, etc.)
  - Good vs bad examples table format helps users understand verification requirements
---
